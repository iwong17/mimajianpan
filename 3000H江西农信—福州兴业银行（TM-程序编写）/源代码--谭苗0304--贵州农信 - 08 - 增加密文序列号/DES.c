#include "DES.h"


unsigned char code des_s[8][64] = {
		14, 0, 4,15,13, 7, 1, 4, 2,14,15, 2,11,13, 8, 1,
		 3,10,10, 6, 6,12,12,11, 5, 9, 9, 5, 0, 3, 7, 8,
		 4,15, 1,12,14, 8, 8, 2,13, 4, 6, 9, 2, 1,11, 7,
		15, 5,12,11, 9, 3, 7,14, 3,10,10, 0, 5, 6, 0,13,
		 
		15, 3, 1,13, 8, 4,14, 7, 6,15,11, 2, 3, 8, 4,14,
		 9,12, 7, 0, 2, 1,13,10,12, 6, 0, 9, 5,11,10, 5,
		 0,13,14, 8, 7,10,11, 1,10, 3, 4,15,13, 4, 1, 2,
		 5,11, 8, 6,12, 7, 6,12, 9, 0, 3, 5, 2,14,15, 9,
		 
		10,13, 0, 7, 9, 0,14, 9, 6, 3, 3, 4,15, 6, 5,10,
		 1, 2,13, 8,12, 5, 7,14,11,12, 4,11, 2,15, 8, 1,
		13, 1, 6,10, 4,13, 9, 0, 8, 6,15, 9, 3, 8, 0, 7,
		11, 4, 1,15, 2,14,12, 3, 5,11,10, 5,14, 2, 7,12,
		
		 7,13,13, 8,14,11, 3, 5, 0, 6, 6,15, 9, 0,10, 3, 
		 1, 4, 2, 7, 8, 2, 5,12,11, 1,12,10, 4,14,15, 9,
		10, 3, 6,15, 9, 0, 0, 6,12,10,11, 1, 7,13,13, 8,
		15, 9, 1, 4, 3, 5,14,11, 5,12, 2, 7, 8, 2, 4,14,
		
		 2,14,12,11, 4, 2, 1,12, 7, 4,10, 7,11,13, 6, 1, 
		 8, 5, 5, 0, 3,15,15,10,13, 3, 0, 9,14, 8, 9, 6,
		 4,11, 2, 8, 1,12,11, 7,10, 1,13,14, 7, 2, 8,13,
		15, 6, 9,15,12, 0, 5, 9, 6,10, 3, 4, 0, 5,14, 3,
		
		12,10, 1,15,10, 4,15, 2, 9, 7, 2,12, 6, 9, 8, 5,
		 0, 6,13, 1, 3,13, 4,14,14, 0, 7,11, 5, 3,11, 8,
		 9, 4,14, 3,15, 2, 5,12, 2, 9, 8, 5,12,15, 3,10,
		 7,11, 0,14, 4, 1,10, 7, 1, 6,13, 0,11, 8, 6,13,
		 
		 4,13,11, 0, 2,11,14, 7,15, 4, 0, 9, 8, 1,13,10, 
		 3,14,12, 3, 9, 5, 7,12, 5, 2,10,15, 6, 8, 1, 6,
		 1, 6, 4,11,11,13,13, 8,12, 1, 3, 4, 7,10,14, 7,
		10, 9,15, 5, 6, 0, 8,15, 0,14, 5, 2, 9, 3, 2,12,
		
		13, 1, 2,15, 8,13, 4, 8, 6,10,15, 3,11, 7, 1, 4,
		10,12, 9, 5, 3, 6,14,11, 5, 0, 0,14,12, 9, 7, 2,
		 7, 2,11, 1, 4,14, 1, 7, 9, 4,12,10,14, 8, 2,13,
		 0,15, 6,12,10, 9,13, 0,15, 3, 3, 5, 5, 6, 8,11};

/*unsigned char code des_s1[4][16] = {
		14, 4, 13, 1, 2, 15, 11, 8, 3, 10, 6, 12, 5, 9, 0, 7,
		0, 15, 7, 4, 14, 2, 13, 1, 10, 6, 12, 11, 9, 5, 3, 8,
		4, 1, 14, 8, 13, 6, 2, 11, 15, 12, 9, 7, 3, 10, 5, 0,
		15, 12, 8, 2, 4, 9, 1, 7, 5, 11, 3, 14, 10, 0, 6, 13  };*/

/*unsigned char code des_s2[4][16] = {
		15, 1, 8, 14, 6, 11, 3, 4, 9, 7, 2, 13, 12, 0, 5, 10,
		3, 13, 4, 7, 15, 2, 8, 14, 12, 0, 1, 10, 6, 9, 11, 5,
		0, 14, 7, 11, 10, 4, 13, 1, 5, 8, 12, 6, 9, 3, 2, 15,
		13, 8, 10, 1, 3, 15, 4, 2, 11, 6, 7, 12, 0, 5, 14, 9   }; */

/*unsigned char code des_s3[4][16] = {
		10, 0, 9, 14, 6, 3, 15, 5, 1, 13, 12, 7, 11, 4, 2, 8,
		13, 7, 0, 9, 3, 4, 6, 10, 2, 8, 5, 14, 12, 11, 15, 1,
		13, 6, 4, 9, 8, 15, 3, 0, 11, 1, 2, 12, 5, 10, 14, 7,
		1, 10, 13, 0, 6, 9, 8, 7, 4, 15, 14, 3, 11, 5, 2, 12   };*/

/*unsigned char code des_s4[4][16] =  {
		7, 13, 14, 3, 0, 6, 9, 10, 1, 2, 8, 5, 11, 12, 4, 15,
		13, 8, 11, 5, 6, 15, 0, 3, 4, 7, 2, 12, 1, 10, 14, 9,
		10, 6, 9, 0, 12, 11, 7, 13, 15, 1, 3, 14, 5, 2, 8, 4,
		3, 15, 0, 6, 10, 1, 13, 8, 9, 4, 5, 11, 12, 7, 2, 14   };*/

/*unsigned char code des_s5[4][16] =  {
		2, 12, 4, 1, 7, 10, 11, 6, 8, 5, 3, 15, 13, 0, 14, 9,
		14, 11, 2, 12, 4, 7, 13, 1, 5, 0, 15, 10, 3, 9, 8, 6,
		4, 2, 1, 11, 10, 13, 7, 8, 15, 9, 12, 5, 6, 3, 0, 14,
		11, 8, 12, 7, 1, 14, 2, 13, 6, 15, 0, 9, 10, 4, 5, 3   };*/

/*unsigned char code des_s6[4][16] = {
		12, 1, 10, 15, 9, 2, 6, 8, 0, 13, 3, 4, 14, 7, 5, 11,
		10, 15, 4, 2, 7, 12, 9, 5, 6, 1, 13, 14, 0, 11, 3, 8,
		9, 14, 15, 5, 2, 8, 12, 3, 7, 0, 4, 10, 1, 13, 11, 6,
		4, 3, 2, 12, 9, 5, 15, 10, 11, 14, 1, 7, 6, 0, 8, 13   };*/

/*unsigned char code des_s7[4][16] = {
		4, 11, 2, 14, 15, 0, 8, 13, 3, 12, 9, 7, 5, 10, 6, 1,
		13, 0, 11, 7, 4, 9, 1, 10, 14, 3, 5, 12, 2, 15, 8, 6,
		1, 4, 11, 13, 12, 3, 7, 14, 10, 15, 6, 8, 0, 5, 9, 2,
		6, 11, 13, 8, 1, 4, 10, 7, 9, 5, 0, 15, 14, 2, 3, 12   };*/

/*unsigned char code des_s8[4][16] = {
		13, 2, 8, 4, 6, 15, 11, 1, 10, 9, 3, 14, 5, 0, 12, 7,
		1, 15, 13, 8, 10, 3, 7, 4, 12, 5, 6, 11, 0, 14, 9, 2,
		7, 11, 4, 1, 9, 12, 14, 2, 0, 6, 10, 13, 15, 3, 5, 8,
		2, 1, 14, 7, 4, 10, 8, 13, 15, 12, 9, 0, 3, 5, 6, 11   };*/

unsigned char code des_IP[8] = {
		6,4,2,0,7,5,3,1};

unsigned char code des_E[6][8] = {
		0x03,0x04,0x03,0x04,0x05,0x06,0x07,0x30,
		0x15,0x16,0x17,0x00,0x17,0x00,0x01,0x02,
		0x27,0x10,0x11,0x12,0x13,0x14,0x13,0x14,
		0x23,0x24,0x23,0x24,0x25,0x26,0x27,0x10,
		0x35,0x36,0x37,0x20,0x37,0x20,0x21,0x22,
		0x07,0x30,0x31,0x32,0x33,0x34,0x33,0x34,};

unsigned char code des_PC_2[6][8] = {
		0x34,0x05,0x03,0x07,0x20,0x15,0x27,0x12,
		0x04,0x14,0x25,0x21,0x16,0x23,0x02,0x11,
		0x06,0x13,0x24,0x35,0x01,0x10,0x00,0x36,
		0x54,0x46,0x75,0x65,0x57,0x45,0x60,0x53,
		0x74,0x55,0x63,0x50,0x64,0x43,0x67,0x61,
		0x44,0x47,0x40,0x62,0x52,0x66,0x77,0x42,};

unsigned char code des_p[4][8] = {
		0x27,0x34,0x14,0x33,0x23,0x24,0x01,0x10,
		0x16,0x31,0x26,0x03,0x36,0x21,0x11,0x07,
		0x17,0x05,0x35,0x30,0x12,0x20,0x00,0x06,
		0x37,0x04,0x15,0x22,0x02,0x32,0x13,0x25};

unsigned char code des_move[]={
		1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1,0}; 


typedef union{
	unsigned long l[2];
	unsigned char c[8];
	}LONG_CHAR;

void des_1(unsigned char *input,unsigned char *output,unsigned char *key,unsigned char flag)
{
	unsigned char xdata temp[20]; //0~3：L，明文置换后左半部分  4~7：R，明文置换后右半部分  8~19：暂存数据，存放过程结果
	LONG_CHAR C_D;//存放C和D
	unsigned char i,j,k;

	//将c中的第d位数据赋值到a中的第b位，a中的数据先要清空。第几位的顺序是由低位往高位数，最低位为第0位
	#define BitToBit(a,b,c,d) a |= (((c) >> (d)) & 1) << (b)


	//明文IP置换
	memset(temp,0,8);
	for(i=0;i<8;i++)
	{
		k = des_IP[i];
		j=8;
		while(j--)
		{
			BitToBit(temp[i],j,input[j],k);
		}
	}

	//密钥PC_1置换
	memset(C_D.c,0,8);
	for(i=0;i<4;i++)
	{
		j=8;
		while(j--)
		{
			BitToBit(C_D.c[i],j,key[j],7-i);
			BitToBit(C_D.c[i+4],j,key[j],i+1);
		}
	}
	C_D.c[7]=C_D.c[3]<<4;


	//16轮计算
	for(i=0;i<16;i++)
	{
		//C、D左移或右移
		if(flag)//加密左移
		{  
			k=des_move[i];
			C_D.c[3] &= 0xf0;
			C_D.c[7] &= 0xf0;
			C_D.l[0] = (C_D.l[0]<<k) | (C_D.l[0]>>(28-k));
			C_D.l[1] = (C_D.l[1]<<k) | (C_D.l[1]>>(28-k));
		}
		else//解密右移
		{
			k=des_move[16-i];
			C_D.c[3] &= 0xf0;
			C_D.c[7] &= 0xf0;
			C_D.l[0] = (C_D.l[0]>>k) | (C_D.l[0]<<(28-k));
			C_D.l[1] = (C_D.l[1]>>k) | (C_D.l[1]<<(28-k));
		}
		
		//R进行E盒计算   C、D进行PC_2压缩运算  将这两个结果进行异或
		memset(temp+8,0,12);
		for(j=0;j<6;j++)
		{
			k=8;
			while(k--)
			{
				//R进行E盒计算
				BitToBit(temp[8+j],k,temp[4+(des_E[j][k]>>4)],des_E[j][k] & 0x0f);
				//C、D进行PC_2压缩运算
				BitToBit(temp[14+j],k,C_D.c[des_PC_2[j][k]>>4],des_PC_2[j][k] & 0x0f);
			}
			temp[8+j]^=temp[14+j];
		}
		
		//S盒运算
		temp[14] = des_s[0][temp[8] >> 2]<<4 | des_s[1][(*((unsigned short*)(temp+8)) >> 4)&0x3f];
		temp[15] = des_s[2][(*((unsigned short*)(temp+9)) >> 6)&0x3f]<<4 | des_s[3][temp[10]&0x3f];
		temp[16] = des_s[4][temp[11] >> 2]<<4 | des_s[5][(*((unsigned short*)(temp+11)) >> 4)&0x3f];
		temp[17] = des_s[6][(*((unsigned short*)(temp+12)) >> 6)&0x3f]<<4 | des_s[7][temp[13]&0x3f];
		
		//P盒 ,
		memset(temp+8,0,4);
		for(j=0;j<4;j++)
		{
			k=8;
			while(k--)
			{
				BitToBit(temp[8+j],k,temp[14+(des_p[j][k]>>4)],des_p[j][k]&0x0f);
			}
			temp[8+j] ^= temp[j];
		}
		
		//交换L、R
		memcpy(temp,temp+4,4);
		memcpy(temp+4,temp+8,4);		
	} 
	memcpy(temp+4,temp,4);
	memcpy(temp,temp+8,4);

	memset(output,0,8);
	for(i=0;i<8;i++)
	{
		k = des_IP[i];
		j=8;
		while(j--)
		{
			BitToBit(output[j],k,temp[i],j);
		}
	}
}

void des_2(unsigned char *input,unsigned char *output,unsigned char *key,unsigned char flag)
{
	des_1(input,output,key,flag);
	des_1(output,input,key+8,!flag);
	des_1(input,output,key,flag);
}

void des_3(unsigned char *input,unsigned char *output,unsigned char *key,unsigned char flag)
{
	des_1(input,output,key,flag);
	des_1(output,input,key+8,!flag);
	des_1(input,output,key+16,flag);
}					
